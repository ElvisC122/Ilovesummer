<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é€²éšäº”åéŸ³ç·´ç¿’æ©Ÿï¼ˆå¤šæ¨¡å¼ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: "M PLUS 1", "å¾®è»Ÿæ­£é»‘é«”", "Microsoft JhengHei", sans-serif;
      background-color: #4f4f4f;
      color: #ccc;
      margin: 0; padding: 0;
      min-height: 100vh;
      user-select: none;
    }
    h1 {
      margin-bottom: 1rem;
      color: #6fbbff;
      text-shadow: 1px 1px 2px #000;
    }
    .page {
      display: none;
      width: 90%;
      max-width: 800px;
      margin: 1rem auto;
      flex-direction: column;
      align-items: center;
    }
    .active-page {
      display: flex;
    }
    .nav-btn {
      margin: 0.5rem;
      min-width: 200px;
    }
    .mode-btn {
      background-color: #5cb85c;
      min-width: 180px;
      height: 80px;
      font-size: 1.2rem;
    }
    .progress-bar {
      height: 20px;
      background-color: #333;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .progress-fill {
      height: 100%;
      background-color: #4CAF50;
      transition: width 0.5s ease;
    }
    .kana-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      width: 100%;
      max-width: 600px;
    }
    .kana-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      padding: 10px;
      text-align: center;
    }
    .achievement {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid gold;
      border-radius: 5px;
      padding: 10px;
      margin: 5px 0;
    }
    .mnemonic-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 1rem 0;
    }
    /* ç·´ç¿’é é¢å°ˆç”¨ */
    #kanaDisplay {
      font-size: 8rem;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px #000;
      user-select: text;
    }
    #controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    #hintDisplay {
      font-size: 3rem;
      color: #a7cfff;
      margin-bottom: 1rem;
      min-height: 3.5rem;
      user-select: text;
    }
    #inputRomaji {
      font-size: 2rem;
      padding: 0.5rem 1rem;
      width: 200px;
      border: none;
      border-radius: 5px;
      outline: none;
      text-align: center;
      margin-bottom: 1rem;
      background: rgba(255 255 255 / 0.1);
      color: #eee;
    }
    #inputRomaji:focus {
      background: rgba(103, 201, 255, 0.2);
      color: #000;
    }
    #result {
      margin-top: 1rem;
      font-size: 1.5rem;
      min-height: 2rem;
      font-weight: 600;
      text-shadow: 1px 1px 2px #000;
      user-select: none;
    }
    #scoreTimer {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      user-select: none;
    }
    #progressSummary {
      margin-top: 1rem;
      font-size: 1rem;
      color: #a7cfff;
      user-select: none;
      max-width: 90vw;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- ä¸»é é¢ -->
<div id="main-page" class="page active-page">
  <h1>äº”åéŸ³ç·´ç¿’æ©Ÿ</h1>
  <div class="controls">
    <button class="nav-btn mode-btn" data-page="practice-page" data-difficulty="basic">åŸºç¤äº”åéŸ³</button>
    <button class="nav-btn mode-btn" data-page="practice-page" data-difficulty="dakuon">æ¿éŸ³ãƒ»åŠæ¿éŸ³</button>
    <button class="nav-btn mode-btn" data-page="practice-page" data-difficulty="yoon">æ‹—éŸ³</button>
    <button class="nav-btn mode-btn" data-page="practice-page" data-difficulty="all">å…¨éƒ¨æ··åˆ</button>
  </div>
  <div class="controls">
    <button class="nav-btn" data-page="progress-page">å­¸ç¿’é€²åº¦</button>
    <button class="nav-btn" data-page="achievements-page">æˆå°±ç³»çµ±</button>
    <button class="nav-btn" data-page="mnemonics-page">è¨˜æ†¶æŠ€å·§</button>
  </div>
</div>

<!-- ç·´ç¿’é é¢ -->
<div id="practice-page" class="page">
  <h1>äº”åéŸ³ç·´ç¿’</h1>
  <div id="kanaDisplay">ã‚</div>
  <div id="controls">
    <button id="hintBtn">é¡¯ç¤ºæç¤ºï¼ˆç‰‡/å¹³å‡åï¼‰</button>
    <button id="playSoundBtn">æ’­æ”¾ç™¼éŸ³ ğŸ”Š</button>
    <button id="skipBtn">è·³é</button>
  </div>
  <div id="hintDisplay"></div>
  <input type="text" id="inputRomaji" placeholder="è«‹è¼¸å…¥ç¾…é¦¬æ‹¼éŸ³" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
  <button id="checkBtn">ç¢ºèª</button>
  <div id="result"></div>
  <div id="scoreTimer">åˆ†æ•¸ï¼š0 | å‰©é¤˜æ™‚é–“ï¼š30ç§’</div>
  <div id="progressSummary">æ•´é«”ç­”é¡Œæ­£ç¢ºç‡ï¼š0%</div>
  <button class="nav-btn" data-page="main-page">è¿”å›ä¸»é¸å–®</button>
</div>

<!-- å­¸ç¿’é€²åº¦é é¢ -->
<div id="progress-page" class="page">
  <h1>å­¸ç¿’é€²åº¦</h1>
  <div class="progress-container">
    <div class="progress-bar">
      <div id="overall-progress" class="progress-fill"></div>
    </div>
    <div class="kana-grid" id="kana-progress-grid"></div>
  </div>
  <button class="nav-btn" data-page="main-page">è¿”å›ä¸»é¸å–®</button>
</div>

<!-- æˆå°±ç³»çµ±é é¢ -->
<div id="achievements-page" class="page">
  <h1>æˆå°±ç³»çµ±</h1>
  <div id="achievements-container"></div>
  <button class="nav-btn" data-page="main-page">è¿”å›ä¸»é¸å–®</button>
</div>

<!-- è¨˜æ†¶æŠ€å·§é é¢ -->
<div id="mnemonics-page" class="page">
  <h1>è¨˜æ†¶æŠ€å·§</h1>
  <div class="controls">
    <button id="prev-mnemonic">ä¸Šä¸€å‰‡</button>
    <button id="next-mnemonic">ä¸‹ä¸€å‰‡</button>
  </div>
  <div class="mnemonic-container">
    <h3 id="mnemonic-char">ã‚</h3>
    <p id="mnemonic-text">Loading...</p>
  </div>
  <button class="nav-btn" data-page="main-page">è¿”å›ä¸»é¸å–®</button>
</div>

<script>
// ===== äº”åéŸ³è³‡æ–™ï¼ˆéƒ¨åˆ†å«è¨˜æ†¶æ³•ï¼‰ =====
const gojuon = [
  { hira: "ã‚", kata: "ã‚¢", romaji: "a", audio: "https://assets.codepen.io/4403884/a.mp3", mnemonic: "åƒä¸€å€‹äººå¼µé–‹å˜´å·´ç™¼ã€å•Šã€çš„å½¢ç‹€" },
  { hira: "ã„", kata: "ã‚¤", romaji: "i", audio: "https://assets.codepen.io/4403884/i.mp3", mnemonic: "å…©æ¢ç›´ç·šåƒè‹±æ–‡å­—æ¯ã€iã€" },
  { hira: "ã†", kata: "ã‚¦", romaji: "u", audio: "https://assets.codepen.io/4403884/u.mp3", mnemonic: "åƒä¸€éš»é³¥çš„å˜´å·´ç™¼ã€å—šã€" },
  { hira: "ãˆ", kata: "ã‚¨", romaji: "e", audio: "https://assets.codepen.io/4403884/e.mp3", mnemonic: "åƒè‹±æ–‡å­—æ¯ã€Lã€ï¼Œç™¼éŸ³åƒã€æ¬¸ã€" },
  { hira: "ãŠ", kata: "ã‚ª", romaji: "o", audio: "https://assets.codepen.io/4403884/o.mp3", mnemonic: "åƒä¸€å€‹äººå½è…°èªªã€å–”ã€" },
  // ...ï¼ˆè«‹è£œé½Šå®Œæ•´ gojuon é™£åˆ—ï¼Œæˆ–ç”¨ä½ åŸå§‹çš„ gojuon è³‡æ–™ï¼‰
];

// ====== é€²åº¦ã€æˆå°±ã€è¨˜æ†¶æ³• ======
const app = {
  currentMnemonicIndex: 0,
  achievements: [
    { id: 1, name: "åˆå­¸è€…", desc: "å®Œæˆ10é¡Œç·´ç¿’", condition: p => p.totalAttempts >= 10, unlocked: false },
    { id: 2, name: "äº”åéŸ³å¤§å¸«", desc: "åŸºç¤äº”åéŸ³æ­£ç¢ºç‡é”90%", condition: p => p.basic.accuracy >= 90, unlocked: false },
    { id: 3, name: "é€£æ“Šé«˜æ‰‹", desc: "é€£çºŒç­”å°10é¡Œ", condition: p => p.maxStreak >= 10, unlocked: false }
  ],
  bindEvents() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', e => this.switchPage(e));
    });
    document.getElementById('prev-mnemonic').addEventListener('click', () => {
      this.currentMnemonicIndex = Math.max(0, this.currentMnemonicIndex - 1);
      this.showMnemonic();
    });
    document.getElementById('next-mnemonic').addEventListener('click', () => {
      this.currentMnemonicIndex = Math.min(gojuon.length - 1, this.currentMnemonicIndex + 1);
      this.showMnemonic();
    });
  },
  switchPage(e) {
    const targetPage = e.target.dataset.page;
    const difficulty = e.target.dataset.difficulty;
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active-page'));
    document.getElementById(targetPage).classList.add('active-page');
    if(targetPage === 'practice-page') practice.init(difficulty);
    if(targetPage === 'progress-page') this.updateProgressDisplay();
    if(targetPage === 'mnemonics-page') this.showMnemonic();
    if(targetPage === 'achievements-page') this.loadAchievements();
  },
  updateProgressDisplay() {
    const progress = practice.loadProgress();
    const total = gojuon.length;
    const mastered = Object.values(progress).filter(p => (p.corrects||0)/(p.attempts||1) >= 0.8).length;
    const percent = (mastered / total * 100).toFixed(1);
    document.getElementById('overall-progress').style.width = `${percent}%`;
    this.renderKanaGrid(progress);
  },
  renderKanaGrid(progress) {
    const grid = document.getElementById('kana-progress-grid');
    grid.innerHTML = '';
    gojuon.forEach((kana, idx) => {
      const card = document.createElement('div');
      card.className = 'kana-card';
      const p = progress[idx] || { attempts: 0, corrects: 0 };
      const accuracy = p.attempts ? Math.round(p.corrects / p.attempts * 100) : 0;
      card.innerHTML = `
        <div class="kana-char">${kana.hira}</div>
        <div class="kana-romaji">${kana.romaji}</div>
        <div class="accuracy-bar" style="width: ${accuracy}%"></div>
        <div>${accuracy}%</div>
      `;
      grid.appendChild(card);
    });
  },
  showMnemonic() {
    const kana = gojuon[this.currentMnemonicIndex];
    document.getElementById('mnemonic-char').textContent = `${kana.hira} / ${kana.kata}`;
    document.getElementById('mnemonic-text').textContent = kana.mnemonic || 'ï¼ˆæš«ç„¡è¨˜æ†¶æ³•ï¼‰';
  },
  loadAchievements() {
    const container = document.getElementById('achievements-container');
    container.innerHTML = '';
    // é€™è£¡å¯æ ¹æ“šå¯¦éš›é€²åº¦è³‡æ–™æ›´æ–°è§£é–ç‹€æ…‹
    this.achievements.forEach(ach => {
      const div = document.createElement('div');
      div.className = `achievement ${ach.unlocked ? '' : 'achievement-locked'}`;
      div.innerHTML = `
        <div class="achievement-icon">ğŸ†</div>
        <h3>${ach.name}</h3>
        <p>${ach.desc}</p>
        ${ach.unlocked ? '<small>å·²è§£é–</small>' : '<small>æœªè§£é–</small>'}
      `;
      container.appendChild(div);
    });
  },
  init() {
    this.bindEvents();
    this.updateProgressDisplay();
    this.loadAchievements();
    this.showMnemonic();
  }
};

// ====== ç·´ç¿’åŠŸèƒ½æ ¸å¿ƒ ======
const practice = {
  wrongList: [],
  currentIndex: -1,
  currentType: "hira",
  score: 0,
  timer: 30,
  timerId: null,
  streak: 0,
  maxStreak: 0,
  difficulty: "all",
  bindPracticeEvents() {
    document.getElementById("hintBtn").onclick = () => {
      const hintType = this.currentType === "hira" ? "kata" : "hira";
      document.getElementById("hintDisplay").textContent = gojuon[this.currentIndex][hintType];
    };
    document.getElementById("playSoundBtn").onclick = () => {
      const audio = new Audio(gojuon[this.currentIndex].audio);
      audio.play();
    };
    document.getElementById("skipBtn").onclick = () => {
      this.nextQuestion();
    };
    document.getElementById("checkBtn").onclick = () => {
      this.checkAnswer();
    };
    document.getElementById("inputRomaji").onkeydown = e => {
      if (e.key === "Enter") this.checkAnswer();
    };
  },
  getFilteredIndices() {
    // æ ¹æ“šé›£åº¦éæ¿¾é¡Œåº«
    if (this.difficulty === "basic") return gojuon.slice(0, 46).map((_, i) => i);
    if (this.difficulty === "dakuon") return gojuon.slice(46, 71).map((_, i) => i + 46);
    if (this.difficulty === "yoon") return gojuon.slice(71).map((_, i) => i + 71);
    return gojuon.map((_, i) => i);
  },
  getNextIndex() {
    const indices = this.getFilteredIndices();
    if (this.wrongList.length > 0 && Math.random() < 0.5) {
      return this.wrongList[Math.floor(Math.random() * this.wrongList.length)];
    }
    return indices[Math.floor(Math.random() * indices.length)];
  },
  nextQuestion() {
    this.currentIndex = this.getNextIndex();
    this.currentType = Math.random() < 0.5 ? "hira" : "kata";
    document.getElementById("kanaDisplay").textContent = gojuon[this.currentIndex][this.currentType];
    document.getElementById("hintDisplay").textContent = "";
    document.getElementById("inputRomaji").value = "";
    document.getElementById("result").textContent = "";
    document.getElementById("result").style.color = "#ccc";
    document.getElementById("result").style.fontWeight = "normal";
    document.getElementById("inputRomaji").focus();
    this.resetTimer();
    app.updateProgressDisplay();
  },
  resetTimer() {
    if (this.timerId) clearInterval(this.timerId);
    this.timer = 30;
    this.updateScoreTimer();
    this.timerId = setInterval(() => {
      this.timer--;
      this.updateScoreTimer();
      if (this.timer <= 0) {
        clearInterval(this.timerId);
        document.getElementById("result").style.color = "#f44336";
        document.getElementById("result").style.fontWeight = "bold";
        document.getElementById("result").textContent = "æ™‚é–“åˆ°ï¼è‡ªå‹•æ›é¡Œï¼Œæ‰£1åˆ†";
        this.score = Math.max(0, this.score - 1);
        this.updateScoreTimer();
        this.addToWrongList(this.currentIndex);
        this.updateProgress(this.currentIndex, false);
        app.updateProgressDisplay();
        setTimeout(() => this.nextQuestion(), 1500);
      }
    }, 1000);
  },
  updateScoreTimer() {
    document.getElementById("scoreTimer").textContent = `åˆ†æ•¸ï¼š${this.score} | å‰©é¤˜æ™‚é–“ï¼š${this.timer}ç§’`;
  },
  checkAnswer() {
    const input = document.getElementById("inputRomaji").value.trim().toLowerCase();
    const correct = gojuon[this.currentIndex].romaji;
    if (input === correct) {
      document.getElementById("result").textContent = "æ­£ç¢ºï¼";
      document.getElementById("result").style.color = "#4CAF50";
      this.score++;
      this.streak++;
      this.maxStreak = Math.max(this.maxStreak, this.streak);
      this.removeFromWrongList(this.currentIndex);
      this.updateProgress(this.currentIndex, true);
      app.updateProgressDisplay();
      setTimeout(() => this.nextQuestion(), 1000);
    } else {
      document.getElementById("result").textContent = `éŒ¯èª¤ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correct}`;
      document.getElementById("result").style.color = "#f44336";
      this.score = Math.max(0, this.score - 1);
      this.streak = 0;
      this.addToWrongList(this.currentIndex);
      this.updateProgress(this.currentIndex, false);
      app.updateProgressDisplay();
      setTimeout(() => this.nextQuestion(), 1500);
    }
    this.updateScoreTimer();
  },
  addToWrongList(idx) {
    if (!this.wrongList.includes(idx)) this.wrongList.push(idx);
  },
  removeFromWrongList(idx) {
    this.wrongList = this.wrongList.filter(i => i !== idx);
  },
  loadProgress() {
    const data = localStorage.getItem("gojuonProgress");
    return data ? JSON.parse(data) : {};
  },
  saveProgress(progress) {
    localStorage.setItem("gojuonProgress", JSON.stringify(progress));
  },
  updateProgress(idx, isCorrect) {
    const progress = this.loadProgress();
    if (!progress[idx]) progress[idx] = { attempts: 0, corrects: 0 };
    progress[idx].attempts++;
    if (isCorrect) progress[idx].corrects++;
    this.saveProgress(progress);
  },
  init(difficulty = "all") {
    this.difficulty = difficulty;
    this.score = 0;
    this.streak = 0;
    this.maxStreak = 0;
    this.wrongList = [];
    this.bindPracticeEvents();
    this.nextQuestion();
    this.updateScoreTimer();
    app.updateProgressDisplay();
  }
};

app.init();
</script>
</body>
</html>
