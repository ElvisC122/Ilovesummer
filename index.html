<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>進階五十音練習機（多模式版）</title>
  <style>
    body {
      font-family: "M PLUS 1", "微軟正黑體", "Microsoft JhengHei", sans-serif;
      background-color: #4f4f4f;
      color: #ccc;
      margin: 0; padding: 0;
      min-height: 100vh;
      user-select: none;
    }
    h1 {
      margin-bottom: 1rem;
      color: #6fbbff;
      text-shadow: 1px 1px 2px #000;
    }
    .page {
      display: none;
      width: 90%;
      max-width: 800px;
      margin: 1rem auto;
      flex-direction: column;
      align-items: center;
    }
    .active-page {
      display: flex;
    }
    .nav-btn {
      margin: 0.5rem;
      min-width: 200px;
    }
    .mode-btn {
      background-color: #5cb85c;
      min-width: 180px;
      height: 80px;
      font-size: 1.2rem;
    }
    .progress-bar {
      height: 20px;
      background-color: #333;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .progress-fill {
      height: 100%;
      background-color: #4CAF50;
      transition: width 0.5s ease;
    }
    .kana-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      width: 100%;
      max-width: 600px;
    }
    .kana-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      padding: 10px;
      text-align: center;
    }
    .achievement {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid gold;
      border-radius: 5px;
      padding: 10px;
      margin: 5px 0;
    }
    .mnemonic-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 1rem 0;
    }
    /* 練習頁面專用 */
    #kanaDisplay {
      font-size: 8rem;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px #000;
      user-select: text;
    }
    #controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    #hintDisplay {
      font-size: 3rem;
      color: #a7cfff;
      margin-bottom: 1rem;
      min-height: 3.5rem;
      user-select: text;
    }
    #inputRomaji {
      font-size: 2rem;
      padding: 0.5rem 1rem;
      width: 200px;
      border: none;
      border-radius: 5px;
      outline: none;
      text-align: center;
      margin-bottom: 1rem;
      background: rgba(255 255 255 / 0.1);
      color: #eee;
    }
    #inputRomaji:focus {
      background: rgba(103, 201, 255, 0.2);
      color: #000;
    }
    #result {
      margin-top: 1rem;
      font-size: 1.5rem;
      min-height: 2rem;
      font-weight: 600;
      text-shadow: 1px 1px 2px #000;
      user-select: none;
    }
    #scoreTimer {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      user-select: none;
    }
    #progressSummary {
      margin-top: 1rem;
      font-size: 1rem;
      color: #a7cfff;
      user-select: none;
      max-width: 90vw;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- 主頁面 -->
<div id="main-page" class="page active-page">
  <h1>五十音練習機</h1>
  <div class="controls">
    <button class="nav-btn mode-btn" data-page="practice-page" data-difficulty="basic">基礎五十音</button>
    <button class="nav-btn mode-btn" data-page="practice-page" data-difficulty="dakuon">濁音・半濁音</button>
    <button class="nav-btn mode-btn" data-page="practice-page" data-difficulty="yoon">拗音</button>
    <button class="nav-btn mode-btn" data-page="practice-page" data-difficulty="all">全部混合</button>
  </div>
  <div class="controls">
    <button class="nav-btn" data-page="progress-page">學習進度</button>
    <button class="nav-btn" data-page="achievements-page">成就系統</button>
    <button class="nav-btn" data-page="mnemonics-page">記憶技巧</button>
  </div>
</div>

<!-- 練習頁面 -->
<div id="practice-page" class="page">
  <h1>五十音練習</h1>
  <div id="kanaDisplay">あ</div>
  <div id="controls">
    <button id="hintBtn">顯示提示（片/平假名）</button>
    <button id="playSoundBtn">播放發音 🔊</button>
    <button id="skipBtn">跳過</button>
  </div>
  <div id="hintDisplay"></div>
  <input type="text" id="inputRomaji" placeholder="請輸入羅馬拼音" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
  <button id="checkBtn">確認</button>
  <div id="result"></div>
  <div id="scoreTimer">分數：0 | 剩餘時間：30秒</div>
  <div id="progressSummary">整體答題正確率：0%</div>
  <button class="nav-btn" data-page="main-page">返回主選單</button>
</div>

<!-- 學習進度頁面 -->
<div id="progress-page" class="page">
  <h1>學習進度</h1>
  <div class="progress-container">
    <div class="progress-bar">
      <div id="overall-progress" class="progress-fill"></div>
    </div>
    <div class="kana-grid" id="kana-progress-grid"></div>
  </div>
  <button class="nav-btn" data-page="main-page">返回主選單</button>
</div>

<!-- 成就系統頁面 -->
<div id="achievements-page" class="page">
  <h1>成就系統</h1>
  <div id="achievements-container"></div>
  <button class="nav-btn" data-page="main-page">返回主選單</button>
</div>

<!-- 記憶技巧頁面 -->
<div id="mnemonics-page" class="page">
  <h1>記憶技巧</h1>
  <div class="controls">
    <button id="prev-mnemonic">上一則</button>
    <button id="next-mnemonic">下一則</button>
  </div>
  <div class="mnemonic-container">
    <h3 id="mnemonic-char">あ</h3>
    <p id="mnemonic-text">Loading...</p>
  </div>
  <button class="nav-btn" data-page="main-page">返回主選單</button>
</div>

<script>
// ===== 五十音資料（部分含記憶法） =====
const gojuon = [
  { hira: "あ", kata: "ア", romaji: "a", audio: "https://assets.codepen.io/4403884/a.mp3", mnemonic: "像一個人張開嘴巴發『啊』的形狀" },
  { hira: "い", kata: "イ", romaji: "i", audio: "https://assets.codepen.io/4403884/i.mp3", mnemonic: "兩條直線像英文字母『i』" },
  { hira: "う", kata: "ウ", romaji: "u", audio: "https://assets.codepen.io/4403884/u.mp3", mnemonic: "像一隻鳥的嘴巴發『嗚』" },
  { hira: "え", kata: "エ", romaji: "e", audio: "https://assets.codepen.io/4403884/e.mp3", mnemonic: "像英文字母『L』，發音像『欸』" },
  { hira: "お", kata: "オ", romaji: "o", audio: "https://assets.codepen.io/4403884/o.mp3", mnemonic: "像一個人彎腰說『喔』" },
  // ...（請補齊完整 gojuon 陣列，或用你原始的 gojuon 資料）
];

// ====== 進度、成就、記憶法 ======
const app = {
  currentMnemonicIndex: 0,
  achievements: [
    { id: 1, name: "初學者", desc: "完成10題練習", condition: p => p.totalAttempts >= 10, unlocked: false },
    { id: 2, name: "五十音大師", desc: "基礎五十音正確率達90%", condition: p => p.basic.accuracy >= 90, unlocked: false },
    { id: 3, name: "連擊高手", desc: "連續答對10題", condition: p => p.maxStreak >= 10, unlocked: false }
  ],
  bindEvents() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', e => this.switchPage(e));
    });
    document.getElementById('prev-mnemonic').addEventListener('click', () => {
      this.currentMnemonicIndex = Math.max(0, this.currentMnemonicIndex - 1);
      this.showMnemonic();
    });
    document.getElementById('next-mnemonic').addEventListener('click', () => {
      this.currentMnemonicIndex = Math.min(gojuon.length - 1, this.currentMnemonicIndex + 1);
      this.showMnemonic();
    });
  },
  switchPage(e) {
    const targetPage = e.target.dataset.page;
    const difficulty = e.target.dataset.difficulty;
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active-page'));
    document.getElementById(targetPage).classList.add('active-page');
    if(targetPage === 'practice-page') practice.init(difficulty);
    if(targetPage === 'progress-page') this.updateProgressDisplay();
    if(targetPage === 'mnemonics-page') this.showMnemonic();
    if(targetPage === 'achievements-page') this.loadAchievements();
  },
  updateProgressDisplay() {
    const progress = practice.loadProgress();
    const total = gojuon.length;
    const mastered = Object.values(progress).filter(p => (p.corrects||0)/(p.attempts||1) >= 0.8).length;
    const percent = (mastered / total * 100).toFixed(1);
    document.getElementById('overall-progress').style.width = `${percent}%`;
    this.renderKanaGrid(progress);
  },
  renderKanaGrid(progress) {
    const grid = document.getElementById('kana-progress-grid');
    grid.innerHTML = '';
    gojuon.forEach((kana, idx) => {
      const card = document.createElement('div');
      card.className = 'kana-card';
      const p = progress[idx] || { attempts: 0, corrects: 0 };
      const accuracy = p.attempts ? Math.round(p.corrects / p.attempts * 100) : 0;
      card.innerHTML = `
        <div class="kana-char">${kana.hira}</div>
        <div class="kana-romaji">${kana.romaji}</div>
        <div class="accuracy-bar" style="width: ${accuracy}%"></div>
        <div>${accuracy}%</div>
      `;
      grid.appendChild(card);
    });
  },
  showMnemonic() {
    const kana = gojuon[this.currentMnemonicIndex];
    document.getElementById('mnemonic-char').textContent = `${kana.hira} / ${kana.kata}`;
    document.getElementById('mnemonic-text').textContent = kana.mnemonic || '（暫無記憶法）';
  },
  loadAchievements() {
    const container = document.getElementById('achievements-container');
    container.innerHTML = '';
    // 這裡可根據實際進度資料更新解鎖狀態
    this.achievements.forEach(ach => {
      const div = document.createElement('div');
      div.className = `achievement ${ach.unlocked ? '' : 'achievement-locked'}`;
      div.innerHTML = `
        <div class="achievement-icon">🏆</div>
        <h3>${ach.name}</h3>
        <p>${ach.desc}</p>
        ${ach.unlocked ? '<small>已解鎖</small>' : '<small>未解鎖</small>'}
      `;
      container.appendChild(div);
    });
  },
  init() {
    this.bindEvents();
    this.updateProgressDisplay();
    this.loadAchievements();
    this.showMnemonic();
  }
};

// ====== 練習功能核心 ======
const practice = {
  wrongList: [],
  currentIndex: -1,
  currentType: "hira",
  score: 0,
  timer: 30,
  timerId: null,
  streak: 0,
  maxStreak: 0,
  difficulty: "all",
  bindPracticeEvents() {
    document.getElementById("hintBtn").onclick = () => {
      const hintType = this.currentType === "hira" ? "kata" : "hira";
      document.getElementById("hintDisplay").textContent = gojuon[this.currentIndex][hintType];
    };
    document.getElementById("playSoundBtn").onclick = () => {
      const audio = new Audio(gojuon[this.currentIndex].audio);
      audio.play();
    };
    document.getElementById("skipBtn").onclick = () => {
      this.nextQuestion();
    };
    document.getElementById("checkBtn").onclick = () => {
      this.checkAnswer();
    };
    document.getElementById("inputRomaji").onkeydown = e => {
      if (e.key === "Enter") this.checkAnswer();
    };
  },
  getFilteredIndices() {
    // 根據難度過濾題庫
    if (this.difficulty === "basic") return gojuon.slice(0, 46).map((_, i) => i);
    if (this.difficulty === "dakuon") return gojuon.slice(46, 71).map((_, i) => i + 46);
    if (this.difficulty === "yoon") return gojuon.slice(71).map((_, i) => i + 71);
    return gojuon.map((_, i) => i);
  },
  getNextIndex() {
    const indices = this.getFilteredIndices();
    if (this.wrongList.length > 0 && Math.random() < 0.5) {
      return this.wrongList[Math.floor(Math.random() * this.wrongList.length)];
    }
    return indices[Math.floor(Math.random() * indices.length)];
  },
  nextQuestion() {
    this.currentIndex = this.getNextIndex();
    this.currentType = Math.random() < 0.5 ? "hira" : "kata";
    document.getElementById("kanaDisplay").textContent = gojuon[this.currentIndex][this.currentType];
    document.getElementById("hintDisplay").textContent = "";
    document.getElementById("inputRomaji").value = "";
    document.getElementById("result").textContent = "";
    document.getElementById("result").style.color = "#ccc";
    document.getElementById("result").style.fontWeight = "normal";
    document.getElementById("inputRomaji").focus();
    this.resetTimer();
    app.updateProgressDisplay();
  },
  resetTimer() {
    if (this.timerId) clearInterval(this.timerId);
    this.timer = 30;
    this.updateScoreTimer();
    this.timerId = setInterval(() => {
      this.timer--;
      this.updateScoreTimer();
      if (this.timer <= 0) {
        clearInterval(this.timerId);
        document.getElementById("result").style.color = "#f44336";
        document.getElementById("result").style.fontWeight = "bold";
        document.getElementById("result").textContent = "時間到！自動換題，扣1分";
        this.score = Math.max(0, this.score - 1);
        this.updateScoreTimer();
        this.addToWrongList(this.currentIndex);
        this.updateProgress(this.currentIndex, false);
        app.updateProgressDisplay();
        setTimeout(() => this.nextQuestion(), 1500);
      }
    }, 1000);
  },
  updateScoreTimer() {
    document.getElementById("scoreTimer").textContent = `分數：${this.score} | 剩餘時間：${this.timer}秒`;
  },
  checkAnswer() {
    const input = document.getElementById("inputRomaji").value.trim().toLowerCase();
    const correct = gojuon[this.currentIndex].romaji;
    if (input === correct) {
      document.getElementById("result").textContent = "正確！";
      document.getElementById("result").style.color = "#4CAF50";
      this.score++;
      this.streak++;
      this.maxStreak = Math.max(this.maxStreak, this.streak);
      this.removeFromWrongList(this.currentIndex);
      this.updateProgress(this.currentIndex, true);
      app.updateProgressDisplay();
      setTimeout(() => this.nextQuestion(), 1000);
    } else {
      document.getElementById("result").textContent = `錯誤，正確答案是：${correct}`;
      document.getElementById("result").style.color = "#f44336";
      this.score = Math.max(0, this.score - 1);
      this.streak = 0;
      this.addToWrongList(this.currentIndex);
      this.updateProgress(this.currentIndex, false);
      app.updateProgressDisplay();
      setTimeout(() => this.nextQuestion(), 1500);
    }
    this.updateScoreTimer();
  },
  addToWrongList(idx) {
    if (!this.wrongList.includes(idx)) this.wrongList.push(idx);
  },
  removeFromWrongList(idx) {
    this.wrongList = this.wrongList.filter(i => i !== idx);
  },
  loadProgress() {
    const data = localStorage.getItem("gojuonProgress");
    return data ? JSON.parse(data) : {};
  },
  saveProgress(progress) {
    localStorage.setItem("gojuonProgress", JSON.stringify(progress));
  },
  updateProgress(idx, isCorrect) {
    const progress = this.loadProgress();
    if (!progress[idx]) progress[idx] = { attempts: 0, corrects: 0 };
    progress[idx].attempts++;
    if (isCorrect) progress[idx].corrects++;
    this.saveProgress(progress);
  },
  init(difficulty = "all") {
    this.difficulty = difficulty;
    this.score = 0;
    this.streak = 0;
    this.maxStreak = 0;
    this.wrongList = [];
    this.bindPracticeEvents();
    this.nextQuestion();
    this.updateScoreTimer();
    app.updateProgressDisplay();
  }
};

app.init();
</script>
</body>
</html>
